#!/usr/bin/env node

const { Command } = require('commander');
const { execSync } = require('child_process');
const path = require('path');
const inquirer = require('inquirer');
const fs = require('fs-extra');
const axios = require('axios');
const AdmZip = require('adm-zip');

const program = new Command();

// Helper function to download and extract versioned src zip file
async function ensureSrcExists(mangoCmsRoot) {
    const srcDir = path.join(mangoCmsRoot, 'src');
    if (!fs.existsSync(srcDir)) {
        // Get the package version
        const packageJsonPath = path.join(mangoCmsRoot, 'package.json');
        let version = '0.1.24'; // Default fallback version

        try {
            if (fs.existsSync(packageJsonPath)) {
                const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
                version = packageJson.version;
            }
        } catch (error) {
            console.log('Error reading package.json:', error.message);
        }

        const zipFileName = `src-v${version}.zip`;
        console.log(`Downloading Mango CMS source files (version ${version})...`);

        const response = await axios({
            method: 'get',
            url: `https://mango-cms.s3.amazonaws.com/${zipFileName}`,
            responseType: 'arraybuffer'
        });

        const tempZipPath = path.join(mangoCmsRoot, zipFileName);
        fs.writeFileSync(tempZipPath, response.data);

        console.log('Extracting source files...');
        const zip = new AdmZip(tempZipPath);
        zip.extractAllTo(mangoCmsRoot, true);

        // Clean up the zip file
        fs.unlinkSync(tempZipPath);
        console.log(`Source files (version ${version}) installed successfully.`);
    }
}

// Helper function to validate and prompt for license if needed
async function ensureLicenseExists(configPath) {
    let settings = {};

    try {
        if (fs.existsSync(configPath)) {
            settings = JSON.parse(fs.readFileSync(configPath, 'utf8'));
        }
    } catch (error) {
        console.log('Error reading settings file:', error.message);
    }

    if (!settings.license) {
        const answer = await inquirer.prompt([
            {
                type: 'input',
                name: 'license',
                message: 'Enter your license key:',
                validate: input => {
                    if (!input) return 'License key is required';
                    if (input !== 'admin') return 'Invalid license key';
                    return true;
                }
            }
        ]);

        settings = {
            ...settings,
            license: answer.license
        };
        fs.mkdirSync(path.dirname(configPath), { recursive: true });
        fs.writeFileSync(configPath, JSON.stringify(settings, null, 2));
    }

    return settings.license;
}

// Helper function to check system dependencies
async function checkSystemDependencies() {
    const checks = {
        mongodb: false,
        redis: false
    };

    console.log('Checking system dependencies...');

    try {
        execSync('mongod --version', { stdio: 'ignore' });
        checks.mongodb = true;
    } catch (error) {
        console.log('❌ MongoDB is not installed. Please install MongoDB:');
        console.log('Mac: brew install mongodb-community');
        console.log('Linux: https://www.mongodb.com/docs/manual/administration/install-on-linux/');
        console.log('Windows: https://www.mongodb.com/docs/manual/tutorial/install-mongodb-on-windows/\n');
    }

    try {
        execSync('redis-cli --version', { stdio: 'ignore' });
        checks.redis = true;
    } catch (error) {
        console.log('❌ Redis is not installed. Please install Redis:');
        console.log('Mac: brew install redis');
        console.log('Linux: https://redis.io/docs/getting-started/installation/install-redis-on-linux/');
        console.log('Windows: https://redis.io/docs/getting-started/installation/install-redis-on-windows/\n');
    }

    if (checks.mongodb && checks.redis) {
        console.log('✅ All system dependencies are installed.\n');
    }

    return checks;
}

program
    .name('mango')
    .description('Mango CMS CLI');

program
    .command('create')
    .description('Create a new Mango CMS project')
    .action(async () => {
        try {

            const answers = await inquirer.prompt([
                {
                    type: 'input',
                    name: 'projectName',
                    message: 'What is your project name?',
                    validate: input => {
                        if (!input) return 'Project name is required';
                        if (fs.existsSync(input)) return 'Directory already exists';
                        return true;
                    }
                },
                {
                    type: 'input',
                    name: 'license',
                    message: 'Enter your license key:',
                    validate: input => {
                        if (!input) return 'License key is required';
                        // For now, just check if it's 'admin'
                        if (input !== 'admin') return 'Invalid license key';
                        return true;
                    }
                }
            ]);

            // First, handle the src.zip download if needed
            await ensureSrcExists(__dirname);

            // Now handle the project creation
            const projectDir = path.join(process.cwd(), answers.projectName);
            const templateDir = path.join(__dirname, 'default');

            // Create project directory and copy template
            console.log(`Creating project in ${projectDir}...`);
            fs.mkdirSync(projectDir);
            fs.copySync(templateDir, projectDir, { filter: (src, dest) => true });

            // Create config directory if it doesn't exist
            const configDir = path.join(projectDir, 'mango');

            // Create or update settings.json
            const settingsPath = path.join(configDir, 'config/settings.json');
            let settings = {};

            try {
                if (fs.existsSync(settingsPath)) {
                    settings = JSON.parse(fs.readFileSync(settingsPath, 'utf8'));
                }
            } catch (error) {
                console.log('Error reading settings file:', error.message);
            }

            // Convert project name to lowercase and remove spaces for domain/DB names
            const projectSlug = answers.projectName.toLowerCase().replace(/[^a-z0-9]/g, '');

            settings = {
                ...settings,
                license: answers.license,
                siteName: answers.projectName,
                siteDomain: `${projectSlug}.com`,
                mangoDomain: `api.${projectSlug}.com`,
                database: `${projectSlug}`,
                s3Bucket: `${projectSlug}`
            };
            fs.mkdirSync(path.dirname(settingsPath), { recursive: true });
            fs.writeFileSync(settingsPath, JSON.stringify(settings, null, 2));

            console.log(`
✨ Project ${answers.projectName} created successfully!
To get started:
  cd ${answers.projectName}
  npm install
  npm run mango start

Make sure MongoDB and Redis services are running before starting the application:
  brew services start mongodb-community
  brew services start redis
`);

            await checkSystemDependencies();

        } catch (error) {
            console.error('Error creating project:', error.message);
            process.exit(1);
        }
    });

program
    .command('init')
    .description('Initialize Mango CMS config in the current directory')
    .action(async () => {
        try {
            const currentDir = process.cwd();
            const templateConfigDir = path.join(__dirname, 'default/mango');
            const targetConfigDir = path.join(currentDir, 'mango');

            // Check if config directory already exists
            if (fs.existsSync(targetConfigDir)) {
                console.log('⚠️  Config directory already exists. Please remove or rename it first.');
                process.exit(1);
            }

            console.log('Initializing Mango CMS config...');

            // Copy config directory
            fs.copySync(templateConfigDir, targetConfigDir);

            console.log(`
✨ Mango CMS config initialized successfully!
`);
        } catch (error) {
            console.error('Error initializing Mango CMS:', error.message);
            process.exit(1);
        }
    });

program
    .command('start')
    .description('Start the Mango CMS in watch mode')
    .action(async () => {
        try {
            await startMangoCMS();
        } catch (error) {
            console.error('Error starting Mango CMS:', error.message);
            process.exit(1);
        }
    });

program
    .command('dev')
    .description('Start the Mango CMS in watch mode (alias for start)')
    .action(async () => {
        try {
            await startMangoCMS();
        } catch (error) {
            console.error('Error starting Mango CMS:', error.message);
            process.exit(1);
        }
    });

// --- Mango UI Dev Command ---
program
    .command('ui <action>')
    .description('Run Mango UI commands (e.g., dev, build, preview)')
    .action(async (action) => {
        const allowed = ['dev', 'build', 'preview'];
        if (!allowed.includes(action)) {
            console.error(`Unknown UI action: ${action}`);
            process.exit(1);
        }
        const uiDir = path.join(__dirname, 'ui');
        const viteConfig = path.join(uiDir, 'vite.config.js');
        // Pass through the Mango config context via cwd and env
        try {
            execSync(
                `npx vite ${action} --config "${viteConfig}"`,
                {
                    cwd: uiDir,
                    stdio: 'inherit',
                    env: {
                        ...process.env,
                        // Optionally add more env vars here if needed
                    }
                }
            );
        } catch (error) {
            console.error(`Error running Mango UI (${action}):`, error.message);
            process.exit(1);
        }
    });

// Helper function for starting Mango CMS
async function startMangoCMS() {
    try {
        // Check system dependencies first
        await checkSystemDependencies();

        // Check for license in settings.json
        const settingsPath = path.join(process.cwd(), 'mango/config/settings.json');
        await ensureLicenseExists(settingsPath);

        // Ensure src exists
        await ensureSrcExists(__dirname);

        // Path to @mango-cms/core inside node_modules
        const cmsPackagePath = path.resolve(__dirname);
        // User's project root (where they run "mango start")
        const userProjectRoot = process.cwd();

        console.log(`Starting Mango CMS...`);
        console.log(`CMS package located at: ${cmsPackagePath}`);
        console.log(`Running in context of: ${userProjectRoot}`);

        // Run Webpack with the config from @mango-cms/core, but in the user's project context
        const webpackConfigPath = path.join(cmsPackagePath, 'webpack.config.js');
        execSync(
            `npx webpack --config "${webpackConfigPath}" --watch --mode development`,
            {
                cwd: cmsPackagePath,
                stdio: 'inherit',
                env: {
                    ...process.env,
                    MANGO_ROOT: cmsPackagePath,
                    PROJECT_ROOT: userProjectRoot
                }
            }
        );
    } catch (error) {
        console.error('Error starting Mango CMS:', error.message);
        process.exit(1);
    }
}

// Helper function to detect web server (nginx or apache)
async function detectWebServer() {
    try {
        // Try nginx first
        execSync('nginx -v', { stdio: 'ignore' });
        return 'nginx';
    } catch (error) {
        try {
            // Try apache next
            execSync('apachectl -v', { stdio: 'ignore' });
            return 'apache';
        } catch (error) {
            return null;
        }
    }
}

// Helper function to generate nginx config
function generateNginxConfig(settings, buildPath) {
    const domain = settings.mangoDomain;
    const port = settings.port || 3002;
    const frontPort = settings.frontPort || 3001;

    return `server {
    root ${buildPath};
    server_name ${domain};

    client_max_body_size 50M;

    location /tmp {
        root ${buildPath};
    }

    ${settings.s3Bucket ? `location /s3/ {
        proxy_pass https://${settings.s3Bucket}.s3.amazonaws.com/;
    }
` : ''}

    location / {
        proxy_http_version 1.1;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://localhost:${port};
    }
}

server {
    server_name ${settings.siteDomain};
    root ${buildPath.replace('/build', '/dist')};
    index index.html;

    # Serve static files directly if they exist
    location ~* \.(?:js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|otf|json|html)$ {
        expires 1y;
        access_log off;
        add_header Cache-Control "public";
        try_files $uri =404;
    }

    ${settings.s3Bucket ? `location /s3/ {
        proxy_pass https://${settings.s3Bucket}.s3.amazonaws.com/;
    }
` : ''}

    # All other routes go to the fallback unless the file exists
    location / {
        try_files $uri @fallback;
    }

    location @fallback {
        proxy_http_version 1.1;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://localhost:${frontPort};
    }
}
`;
}

// Helper function to generate apache config
function generateApacheConfig(settings, buildPath) {
    const domain = settings.mangoDomain;
    const port = settings.port || 3002;

    return `<VirtualHost *:80>
    ServerName ${domain}
    DocumentRoot ${buildPath}

    ProxyRequests Off
    ProxyPreserveHost On

    <Directory ${buildPath}>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    ${settings.s3Bucket ? `ProxyPass /s3/ https://${settings.s3Bucket}.s3.amazonaws.com/
    ProxyPassReverse /s3/ https://${settings.s3Bucket}.s3.amazonaws.com/
` : ''}

    ProxyPass / http://localhost:${port}/
    ProxyPassReverse / http://localhost:${port}/

    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"

    ErrorLog \${APACHE_LOG_DIR}/${domain}-error.log
    CustomLog \${APACHE_LOG_DIR}/${domain}-access.log combined
</VirtualHost>

<VirtualHost *:80>
    ServerName ${settings.siteDomain}
    DocumentRoot ${buildPath.replace('/build', '/dist')}
    IndexIndex index.html

    # Serve static files directly
    <FilesMatch \.\.(?:js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|otf|json)$>
        Header set Cache-Control "max-age=31536000"
    </FilesMatch>

    ${settings.s3Bucket ? `ProxyPass /s3/ https://${settings.s3Bucket}.s3.amazonaws.com/
    ProxyPassReverse /s3/ https://${settings.s3Bucket}.s3.amazonaws.com/
` : ''}

    ProxyPass / http://localhost:${frontPort}/
    ProxyPassReverse / http://localhost:${frontPort}/

    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"

    ErrorLog \${APACHE_LOG_DIR}/${settings.siteDomain}-error.log
    CustomLog \${APACHE_LOG_DIR}/${settings.siteDomain}-access.log combined
</VirtualHost>
`;
}

// Helper function to configure web server
async function configureWebServer(settings, buildPath) {
    let webServer = await detectWebServer();

    if (!webServer) {
        const { server } = await inquirer.prompt([
            {
                type: 'list',
                name: 'server',
                message: 'Which web server would you like to use?',
                choices: ['nginx', 'apache']
            }
        ]);
        webServer = server;
    }

    const config = webServer === 'nginx' ?
        generateNginxConfig(settings, buildPath) :
        generateApacheConfig(settings, buildPath);

    const configPath = webServer === 'nginx' ?
        `/etc/nginx/sites-available/${settings.database.toLowerCase()}` :
        `/etc/apache2/sites-available/${settings.database.toLowerCase()}.conf`;

    try {
        // Check if config already exists
        if (fs.existsSync(configPath)) {
            console.log(`${webServer} configuration already exists at ${configPath}, skipping creation`);
        } else {
            // Write config file only if it doesn't exist
            fs.writeFileSync(configPath, config);
            console.log(`Created ${webServer} configuration at ${configPath}`);

            if (webServer === 'nginx') {
                // Create symlink if it doesn't exist
                const enabledPath = `/etc/nginx/sites-enabled/${settings.database.toLowerCase()}`;
                if (!fs.existsSync(enabledPath)) {
                    execSync(`sudo ln -s ${configPath} ${enabledPath}`);
                }
                execSync('sudo nginx -t');
                execSync('sudo systemctl reload nginx');
            } else {
                // Enable apache site
                execSync(`sudo a2ensite ${settings.database.toLowerCase()}`);
                execSync('sudo systemctl reload apache2');
            }
            console.log(`${webServer} configuration has been updated and service reloaded`);
        }

    } catch (error) {
        console.error(`Error configuring ${webServer}:`, error.message);
        throw error;
    }
}

// Helper function to check if PM2 is installed
async function checkPM2() {
    try {
        execSync('pm2 -v', { stdio: 'ignore' });
        return true;
    } catch (error) {
        console.error('PM2 is not installed. Please install it using: npm install -g pm2');
        return false;
    }
}

// Helper function to manage PM2 process
async function managePM2Process(settings) {
    const processName = `${settings.database.toLowerCase()}-mango`;
    const name = settings.database.toLowerCase()

    try {
        // Check if process exists
        const processListOutput = execSync('pm2 list', { encoding: 'utf8' });
        let processExists = processListOutput.includes(processName);

        if (processExists) {
            console.log(`Reloading PM2 process: ${processName}`);
            execSync(`pm2 reload ${processName}`);
        } else {
            console.log(`Starting new PM2 process: ${processName}`);
            execSync(`pm2 start index.js --name ${processName}`, { cwd: './build' });
        }

        processExists = processListOutput.includes(name);

        if (processExists) {
            console.log(`Reloading PM2 process: ${name}`);
            execSync(`pm2 reload ${name}`);
        } else {
            console.log(`Starting new PM2 process: ${name}`);
            execSync(`pm2 start index.js --name ${name}`, { cwd: './dist' });
        }

    } catch (error) {
        console.error('Error managing PM2 process:', error.message);
        throw error;
    }
}

program
    .command('deploy')
    .description('Build and deploy Mango CMS using PM2')
    .action(async () => {
        try {
            const configPath = path.join(process.cwd(), 'mango/config/settings.json');
            const settings = JSON.parse(fs.readFileSync(configPath, 'utf8'));

            // Run build command
            console.log('Building Mango CMS...');
            execSync('npm run mango build', { stdio: 'inherit' });

            // Check if PM2 is installed
            if (await checkPM2()) {
                await managePM2Process(settings);

                // Configure web server
                const buildPath = path.join(process.cwd(), 'build');
                try {
                    await configureWebServer(settings, buildPath);
                } catch (error) {
                    console.warn('Warning: Could not configure web server:', error.message);
                    console.warn('You may need to configure your web server manually.');
                }

                console.log('Deployment completed successfully!');
            }
        } catch (error) {
            console.error('Deployment failed:', error.message);
            process.exit(1);
        }
    });

program
    .command('build')
    .description('Build the Mango CMS for production')
    .action(async () => {
        try {
            // Check for license in settings.json
            const settingsPath = path.join(process.cwd(), 'mango/config/settings.json');
            await ensureLicenseExists(settingsPath);

            // Ensure src exists
            await ensureSrcExists(__dirname);

            // Path to @mango-cms/core inside node_modules
            const cmsPackagePath = path.resolve(__dirname);
            // User's project root (where they run "mango build")
            const userProjectRoot = process.cwd();

            console.log(`Building Mango CMS for production...`);
            console.log(`CMS package located at: ${cmsPackagePath}`);
            console.log(`Building in context of: ${userProjectRoot}`);

            // Run Webpack with the config from @mango-cms/core in production mode
            const webpackConfigPath = path.join(cmsPackagePath, 'webpack.config.js');
            execSync(
                `npx webpack --config "${webpackConfigPath}" --mode production`,
                {
                    cwd: cmsPackagePath,
                    stdio: 'inherit',
                    env: {
                        ...process.env,
                        NODE_ENV: 'production',
                        MANGO_ROOT: cmsPackagePath,
                        PROJECT_ROOT: userProjectRoot
                    }
                }
            );

            console.log('\n✨ Build completed successfully!');
        } catch (error) {
            console.error('Error building Mango CMS:', error.message);
            process.exit(1);
        }
    });

program
    .command('update')
    .description('Update Mango CMS source files to the latest version')
    .action(async () => {
        try {
            // Path to @mango-cms/core inside node_modules
            const cmsPackagePath = path.resolve(__dirname);

            // Get the package version
            const packageJsonPath = path.join(cmsPackagePath, 'package.json');
            let version = '0.1.24'; // Default fallback version

            try {
                if (fs.existsSync(packageJsonPath)) {
                    const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
                    version = packageJson.version;
                }
            } catch (error) {
                console.log('Error reading package.json:', error.message);
            }

            // Force remove existing src directory
            const srcDir = path.join(cmsPackagePath, 'src');
            if (fs.existsSync(srcDir)) {
                console.log('Removing existing source files...');
                fs.removeSync(srcDir);
            }

            const zipFileName = `src-v${version}.zip?v=${Date.now()}`;
            console.log(`Downloading Mango CMS source files (version ${version})...`);

            const response = await axios({
                method: 'get',
                url: `https://mango-cms.s3.amazonaws.com/${zipFileName}`,
                responseType: 'arraybuffer'
            });

            const tempZipPath = path.join(cmsPackagePath, zipFileName);
            fs.writeFileSync(tempZipPath, response.data);

            console.log('Extracting source files...');
            const zip = new AdmZip(tempZipPath);
            zip.extractAllTo(cmsPackagePath, true);

            // Clean up the zip file
            fs.unlinkSync(tempZipPath);
            console.log(`Source files (version ${version}) updated successfully.`);

        } catch (error) {
            console.error('Error updating Mango CMS source files:', error.message);
            process.exit(1);
        }
    });

program.parse(process.argv);
